#!/usr/bin/python3
# --------------------------------------------------------------------------
# Class definition of TankControllerThread - utility functions for the tank
#
# Author: Benjamin Fuchs
# License: GPL3
#
# Website: https://github.com/benjaminfuchs/who_disposer
#
# --------------------------------------------------------------------------

import time
from threading import Thread


class TankControllerThread(Thread):
    """ TankControllerThread thread """

    POLL_INTERVAL = 1

    def __init__(self, settings):
        """ Constructor """

        super(TankControllerThread, self).__init__(
            name="TankControllerThread")
        self._settings = settings
        self._settings.log.msg("TankControllerThread: init")
        self._stop_event = settings.stop_event
        self._warning = settings.get('tank.warning')
        self._empty = settings.get('tank.empty')
        self._size = settings.get('tank.size')
        self._milliliter = settings.get('milliliter')
        self._reset_time = 3
        self._button_start_time = 0
        self._button_status = None
        settings.add_settings_listener('tank.count', self.on_count)
        settings.add_settings_listener('button.status', self.on_button)

    def run(self):
        """ run method of thread """

        self._settings.log.msg(
            "TankControllerThread: running ...")

        while not self._stop_event.wait(TankControllerThread.POLL_INTERVAL):
            if self._button_status == "on" and \
                    (time.time() - self._button_start_time) >= self._reset_time:
                self._settings.set('tank.state', 'full')
                self._settings.set('tank.count', 0)
                self._settings.log.msg(
                    "TankControllerThread: [INFO] tank full")

        self._settings.log.msg("TankControllerThread: shutdown")

    def on_count(self, name, old, new):
        """ process count changes """

        self._settings.log.msg(
            "TankControllerThread: [INFO] count (%s)" % new)
        if new * self._milliliter >= self._empty * self._size:
            self._settings.set('tank.state', 'empty')
        elif new * self._milliliter >= self._warning * self._size:
            self._settings.set('tank.state', 'warning')

    def on_button(self, name, old, new):
        """ process button changes """

        self._button_status = new
        if old == "off":
            self._button_start_time = time.time()
