#!/usr/bin/python3
# --------------------------------------------------------------------------
# Class definition of SensorsControllerThread - utility functions for the sensors
#
# Author: Benjamin Fuchs
# License: GPL3
#
# Website: https://github.com/benjaminfuchs/who_disposer
#
# --------------------------------------------------------------------------

import time
from threading import Thread

from nsonic.Button import Button
from nsonic.SRF02 import SRF02
from nsonic.HCSR04 import HCSR04


class SensorsControllerThread(Thread):
    """ SensorsControllerThread thread """

    POLL_INTERVAL = 1

    def __init__(self, settings):
        """ Constructor """

        super(SensorsControllerThread, self).__init__(
            name="SensorsControllerThread")
        self._settings = settings
        self._settings.log.msg("SensorsControllerThread: init")
        self._stop_event = settings.stop_event
        self._settings.log.msg(
            "SensorsControllerThread: setting up %s" % settings.get_value('GPIO', 'button'))
        self._button = Button(int(settings.get_value('GPIO', 'button')))
        self._sensor_type = settings.get_value('SENSORS', 'sonic')
        if self._sensor_type == "SRF02":
            self._sensor = SRF02(0x70, settings.get('sensors.threshold'))
        elif self._sensor_type == "HCSR04":
            self._sensor = HCSR04(27, 18, settings.get('sensor.threshold'))
        else:
            self._settings.log.msg(
                "SensorsControllerThread: [ERROR] Unkown sensor type (%s)" % str(self._sensor_type))
        self._state = settings.get('state')
        self._button_count = 0
        self._button.add_listener(self._update_button)
        self._sensor.add_listener(self._update_sensor)

        self._sensor.calibrate()
        self._settings.log.msg(
            "SensorsControllerThread: changing state to running")
        self._settings.set("state", "running")

        self._button.start()
        self._sensor.start()

    def run(self):
        """ run method of thread """

        self._settings.log.msg(
            "SensorsControllerThread: running ...")

        while not self._stop_event.wait(SensorsControllerThread.POLL_INTERVAL):
            pass

        self._button.stop()
        self._sensor.stop()
        self._button.join()
        self._sensor.join()
        self._settings.log.msg("SensorsControllerThread: shutdown")

    def _update_sensor(self, state):
        """ check button status """

        self._settings.log.msg("SensorsControllerThread: sensor %s" % state)
        self._settings.set("sensor.status", state)

    def _update_button(self, state):
        """ check button status """

        self._settings.log.msg("SensorsControllerThread: button %s" % state)
        self._settings.set("button.status", state)
